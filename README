Installation
============
It is recommanded to use Debian 6 (Squeeze) or above

aptitude install python-django python-psycopg2 postgresql libapache2-mod-python libapache2-mod-auth-pgsql libjs-jquery pwgen python-uno oomailing python-decoratedstr

oomailing and python-decoratedstr packages can be downloaded at http://www.nirgal.com/debian/

Base directory should be /usr/lib/ngw

You need to edit your settings.py:
- Put your database user/password there
- Put something in SECRET_KEY:
  from django.utils.crypto import get_random_string
  get_random_string(50, 'abcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*(-_=+)')

Apache
======
Enable ssl, auth_pgsql in apache:
a2enmod ssl 000_auth_pgsql

Generate self-signed certificate:
openssl req -nodes -x509 -days 3650 -new -newkey rsa:2048 -subj /CN=ngw.example.net -keyout ngw.key -out ngw.crt

Listen on port 443
Add a new line "Listen 443" to /etc/apache2/ports.conf" if it's now there allready

Enable virtual hosts on https:
Add a new line "NameVirtualHost *:443" before "Listen 443"

Add "Listen 11371" at the end of the file

Postgres
========
createdb ngw -E unicode

Rigth now, it's not possible to start from an empty database. You need to restore a backup.
See funtions.sql for the list of functions.

Static files and thumbnails
===========================
php5 php5-gd

user or group www-data should have write access to /var/lib/ngw/static/static/g

GPG
===
mkdir /var/lib/ngw
chown www-data /var/lib/ngw

Right now, keys needs to be imported by hand: gpg --homedir /var/lib/ngw/ --import akey.key

Phpbb3 extension (optional)
===========================
Note: This section documentation is incomplete

Create a specific postgres user and database:
su - postgres -c "createuser --no-superuser --createdb --no-createrole phpbb3"
su - postgres -c "psql -c '\password phpbb3'"
su - postgres -c "createdb phpbb3 -O phpbb3"

Install the packages:
aptitude install phpbb3 php5-pgsql php5-curl php5-cli sudo

You will want to setup things manually.
/etc/phpbb3/database.inc.php should contain something like:
<?php
##
## database access settings in php format
## automatically generated from /etc/dbconfig-common/phpbb3.conf
## by /usr/sbin/dbconfig-generate-include
## Mon, 08 Dec 2008 12:28:45 +0100
##
## by default this file is managed via ucf, so you shouldn't have to
## worry about manual changes being silently discarded.  *however*,
## you'll probably also want to edit the configuration file mentioned
## above too.
##
$dbuser='phpbb3';
$dbpass='superpassword';
$basepath='';
$dbname='phpbb3';
$dbserver='127.0.0.1';
$dbport='5432';
$dbtype='pgsql';
?>

If you get a white page, make sure you restart apache, not just reload it.

The password to the phpbb database should be set in the ~/.pgpass file.
This is nice not to have it in many places, but this is a problem for the www-data user since its home directory is available to public.
So you must explicitly forbid its download. I suggest you add a file in /etc/apache2/conf.d/ containing:
<Files ~ "^\.pgpass">
    Order allow,deny
    Deny from all
</Files>

The .pgpass file syntax is available at http://www.postgresql.org/docs/8.3/interactive/libpq-pgpass.html
It might be something like:
localhost:5432:phpbb3:phpbb3:XXXXXXXX
Make sure the file is also protected locally:
localhost:~# chown www-data:www-data /var/www/.pgpass
localhost:~# chmod 600 /var/www/.pgpass

The first time you install the database, you'll need to initialise it:
psql phpbb3  -h localhost -U phpbb3 -W -f /usr/share/dbconfig-common/data/phpbb3/install/pgsql
But you will generally prefer to restore a backup of phpbb3 database with that command:
psql phpbb3 -h localhost -U phpbb3 -f backup_phpbb3.sql

Make sure you have the same password in the two systems (ngw & phpbb3)

Then:
rm /etc/apache2/conf.d/phpbb3.conf

Add to your ngw/apache.conf:
    Include "/etc/phpbb3/apache2.conf"
    <Location "/phpbb/">
        require valid-user
    </Location>

In the admin control panel, in general, in client communication, in authentication, change authentication method from "Db" to "Apache".


Install french packs:
wget http://www.phpbb.com/files/language_packs_30x/lang_fr.tar.gz
wget http://www.phpbb.com/files/language_packs_30x/prosilver_fr.tar.gz
wget http://www.phpbb.com/files/language_packs_30x/subsilver2_fr.tar.gz
tar xvfz lang_fr.tar.gz -C /usr/share/phpbb3/www/language/
tar xvfz prosilver_fr.tar.gz -C /usr/share/phpbb3/styles/
tar xvfz subsilver2_fr.tar.gz -C /usr/share/phpbb3/styles/
If you retore a database, you have nothing more to do. If this is a fresh install, you'll need to log in the administrator control panel, go to system, then install the language.

and set it as default. Many settings should be customized, such as "activation du compte" in "RÃ©glage des inscriptions"; the fact that groups are closed; and so on...

In the admin control panel:
 General
  Board configuration
   Board settings
    Default Language = fr
 Permissions
  Global permissions
   Group' permissions
    Registered users
     Advanced permissions
      Profile
       Change email address = No
      -> Apply
 System
  Module Management
   User Control Panel
    disable all modules but profile


You need to patch phpbb3 in order to forward password change requests to ngw main database:

First make sure apt-get upgrades won't erase the patches automatically:
aptitude hold phpbb3

Apply the phpbb patches:
cd /usr/share/phpbb3/
patch -p1 < /home/admin/ngw/extensions/phpbb/phpbb_ngw.patch

If there is phpbb3 updates, you'll have to reapply the patch after each update.


The synchronisation between the 2 databases, the main one and the phpbb one require the auxiliary base to full its cache.

Right now, this is done with a sudo command. So you need to allow it. With visudo command as root, add this line:
ALL     ALL=(www-data) NOPASSWD: /usr/lib/ngw/extensions/phpbb/clearcache.php

You also will need to synchronise the 2 databases:
/usr/lib/ngw/extensions/phpbb/__init__.py full
Add to purge the cache:
sudo -u www-data /usr/lib/ngw/extensions/phpbb/clearcache.php

Right now, the phpbb forum runs on a different virtual host, so you'll need to enable it:
ln -s /usr/lib/ngw/extensions/phpbb/apache.conf /etc/apache/site-enabled/phpbb.conf
Don't forget to set up the main ngw databse in this file.

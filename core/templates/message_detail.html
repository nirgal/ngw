{% extends "admin/base_site.html" %}
{% load static i18n ngwtags %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static "mimsg/mimsg.css" %}">

<script type=module>
import { MiMsgPart, normalizeCRLF, randomId, arrayIndexOfArray, parse_message,
         textEncode, textDecode, htmlEscape
       } from '{% static "mimsg/mimsg.js" %}';

/*
 * Converts a Uint8Array message in html
 * Supports for obsolete messages that are plain text without headers
 */
function msg_to_html(u8arr) {
    /* Begin of temporary hack for obsolete non-mime messages */
    const mimehint = textEncode('MIME-Version:');
    var mimepos = arrayIndexOfArray(u8arr, mimehint);
    if (mimepos == -1 || mimepos > 20000) {
        // Assume this is an old non-mime message (no RFC822 headers)
        return textDecode(u8arr).replace(/\n/g, '<br>');
    }
    /* End of hack, here we assume this is a RFC822 formatted message */

    var msg = parse_message(u8arr);
    return msg.toHtml();
}

window.addEventListener('load', function() {
    for (let msg of document.getElementsByClassName('rawmimsg')) {
        let content = msg.dataset.raw;
        content = normalizeCRLF(content);
        content = textEncode(content);
        content = msg_to_html(content);
        msg.innerHTML = content;
    }
});
    </script>
{% endblock %}

{% block submenu %}
{% include "group_submenu.html" %}
{% endblock %}

{% block content %}
<div id="content-main">
{% include "membership_inlineform.html" %}
<div class="module padded">
    <div style="float:right;" id=msgdebuglink><a href="#" onclick="$('#msgdebug').css('display','block'); $('#msgdebuglink').css('display','none');">{% trans "Show debug information" %}</a></div>
    {% if object.is_answer %}{% trans "From" %}{% else %}{% trans "To" %}{% endif %}:
    <a href="{{cig_url}}/">{{object.contact.name}}</a>
    (
    <a href="#" onclick="inline_edit_membership('{{membership_title|escapejs}}', '{{cig_url|escapejs}}', '{{ membership }}', '{{membership_note|escapejs}}');">
    {{ membership_str }}
    )
    {% if membership_note %} ( {{ membership_note }} ) {% endif %}
    </a>
    <br>
    {% if object.is_answer %}{% trans "Received" %}{% else %}{% trans "Sent" %}{% endif %}: {{object.send_date}} UTC<br>
    {% trans "Subject" %}: {{object.subject}}<br>
    {% if not object.is_answer and object.read_date %}
        {% trans "Read by recipent" %}: {{ object.read_date }} UTC<br>
    {% endif %}
    <span id=msgdebug style="display:none">
        Message-Id: {{ object.id }}<br>
        {% for k,v in sync_info.items %}
        {{ k }}: {{ v }}<br>
        {% endfor %}
    </span>
    <br>
    <br>
    <div class=rawmimsg data-raw="{{ object.text }}">{% trans "Analyzing message..." %}</div>
</div>

{% for message in object.get_related_messages %}
{% if forloop.first %}
<h3>{% trans "Related messages" %}</h3>
<ul>
{% endif %}
<li><a href={{message.id}}>{{ message.nice_flags}} {{ message.send_date }} - {{ message.subject }}</a>
{% if forloop.last %}
</ul>
{% endif %}
{% endfor %}

{% if 'X' in cg_perms %}
<div class="submit-row">
<form method=post>
{% csrf_token %}
{% if object.is_answer and reply_url %}
<a class='button' href="{{reply_url}}">{% trans "Reply" %}</a>
{% endif %}
{% if object.is_answer %}
<input type=submit name=unread value="{% trans "Flag as unread" %}">
{% endif %}
<p class="deletelink-box"><a href="{{ object.id }}/delete" class="deletelink">{% trans "Delete" %}</a></p>
</form>

</div>
{% endif %}

</div>
{% endblock %}
{# vim: set et ts=4 ft=htmldjango: #}

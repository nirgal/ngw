{% extends "contact_list.html" %}
{% load i18n staticfiles ngwtags %}

{% block submenu %}
{% include "group_submenu.html" %}
{% endblock %}

{% block prequerylist %}
<div class="module padded">
    {% if cg.description %}{{ cg.description|linebreaksbr }}<br>{% endif %}
    {% if cg.date %}<br>
        {% ifequal cg.date cg.end_date %}
        {% trans "Date" %}: <b>{{ cg.date|date:"DATE_FORMAT" }}</b>
        {% else %}
        {% blocktrans with start_date=cg.date|date:"DATE_FORMAT" end_date=cg.end_date|date:"DATE_FORMAT" %}Dates: From <b>{{ start_date }}</b> to <b>{{ end_date }}</b>{% endblocktrans %}
        {% endifequal %}
    {% endif %}
    {% if cg.budget_code %}<br>{% trans "Budget code" %}: <b>{{ cg.budget_code }}</b>{% endif %}
    {% if cg.mailman_address %}<br>{% trans "Mailing list" %}: <b>{{ cg.mailman_address }}</b>{% endif %}
    <br>{% if cg.busy %}{% trans "Members are <b>unavailable</b> for other events." %} <span class=iconbusy></span>{% else %}{% trans "Members are <b>available</b> for other events." %}{% endif %}
</div>
    {{ block.super }}
{% endblock %}


{% block presubmitbar %}
{% trans "Sorry, personnal calendar can't be loaded. Please try again later." as busy_loading_error %}
{% trans "Some events you don't have access to" as busy_forbidden_event %}
{% trans "And dome events you don't have access to" as busy_and_forbidden_event %}
<script>
    const busy_gid = "{{ cg.id }}";
    {% if cg.date %}
    const busy_start = "{{ cg.date|date:"Y-m-d" }}";
    const busy_end = "{{ cg.end_date|date:"Y-m-d" }}";
    const busy_url_extra = '/' + busy_start + '/' + busy_end;
    {% else %}
    const busy_url_extra = '';
    {% endif %}

    for (let e of document.getElementsByClassName('iconbusy')) {
        if (!('contactid' in e.dataset))
            continue;
        let contactid = e.dataset['contactid'];
        e.addEventListener('click', function() {

            let xhr = new XMLHttpRequest();
            let url = '/contacts/' + contactid + '/unavail_detail' + busy_url_extra;
            xhr.open('GET', url);
            xhr.responseType = 'json';
            xhr.onload = function() {

                if (xhr.status != 200) {
                    loading_node.innerHTML = '{{ busy_loading_error|escapejs }}';
                    return;
                }

                let text = '';
                for (let gid in xhr.response.events) {
                    if (gid == busy_gid)
                        continue;
                    let e = xhr.response.events[gid];
                    text += e.name+' ('+e.description+')\n';
                }
                if (xhr.response.invisible_events) {
                    if (text)
                        text += '{{ busy_and_forbidden_event|escapejs }}';
                    else
                        text += '{{ busy_forbidden_event|escapejs }}';
                }
                alert(text);
            }
            xhr.send();
        });
    }
</script>
    {{ block.super }}
    {% ifnotequal cg.id 1 %}{# FIXME #}
    {% if "g" in display %}
        {% for sg in cg.get_direct_subgroups|group_visible_by:user.id %}
            {% if forloop.first %}
                <div class=module>
                    <h2>{% trans "Sub groups" %}</h2>
                    <div class=padded>
                        {% trans "People in sub-groups automatically are members / invited." %}
                        <br>
            {% endif %}
                        ‣ {{ sg|group_with_link }}
                        {% for ssg in sg.get_subgroups|group_visible_by:user.id %}
                        {% if forloop.first %}( {% trans "including" %} {% else %}, {% endif %}
                        {{ ssg|group_with_link }}
                        {% if forloop.last %}){% endif %}
                        {% endfor %}
                        <br>
            {% if forloop.last %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}
    {% endifnotequal %}
    
    {% if "a" in display %}
    {% for sg in cg.get_manager_groups|group_visible_by:user.id %}
        {% if forloop.first %}
            <div class=module>
                <h2>{% trans "Groups that have some access to" %} {{ cg }}</h2>
                <div class=padded>
        {% endif %}
        ‣ {{ sg|group_with_link }}<br>
        {% if forloop.last %}
                </div>
             </div>
        {% endif %}
    {% endfor %}
    {% endif %}
{% endblock %}

    
{% block submitbar %}
<div class="submit-row" id=submitbar>
    <a class="button default" href="javascript:show_column_selection();"> {% trans "Select displayed columns" %}</a>
    <a class=button href="{{cg.get_absolute_url}}edit">{% trans "Edit" %}</a>
    {% if not cg.date and not cg.virtual %}
    <a class=button href="add">{% trans "Create a new contact in that group" %}</a>
    {% endif %}
</div>
{% endblock %}
{# vim: set et ts=4 ft=htmldjango: #}
